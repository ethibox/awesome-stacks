# DOMAIN=example.com docker stack deploy -c discourse.yml discourse
# rake admin:create

services:
  app:
    image: discourse/discourse:${VERSION:-3.5.2}
    volumes:
      - ${VOLUME_PATH}data:/shared
    environment:
      - LANG=${LANG:-fr_FR.UTF-8}
      - DISCOURSE_DB_PORT=5432
      - DISCOURSE_DB_HOST=postgres
      - DISCOURSE_DB_NAME=discourse
      - DISCOURSE_DB_USERNAME=discourse
      - DISCOURSE_DB_PASSWORD=myp@ssw0rd
      - DISCOURSE_REDIS_HOST=redis
      - DISCOURSE_REDIS_PORT=6379
      - DISCOURSE_SMTP_PORT=${SMTP_PORT:-587}
      - DISCOURSE_SMTP_USER_NAME=${SMTP_USER}
      - DISCOURSE_SMTP_PASSWORD=${SMTP_PASSWORD}
      - DISCOURSE_SMTP_ENABLE_START_TLS=${SMTP_TLS:-true}
      - DISCOURSE_SMTP_ADDRESS=${SMTP_HOST:-smtp.example.com}
      - DISCOURSE_DEVELOPER_EMAILS=${ADMIN_EMAIL:-admin@example.com}
      - DISCOURSE_NOTIFICATION_EMAIL=${SMTP_FROM:-noreply@example.com}
      - DISCOURSE_HOSTNAME=${DOMAIN:-discourse.localhost}
      - DISCOURSE_FORCE_HTTPS=${FORCE_HTTPS:-true}
      - GITLAB_APP_ID=${GITLAB_APP_ID}
      - GITLAB_SECRET=${GITLAB_SECRET}
      - GITLAB_URL=${GITLAB_URL}
    deploy:
      labels:
        - traefik.enable=true
        - traefik.http.routers.discourse-${NUMBER:-1}.rule=Host(`${DOMAIN:-discourse.localhost}`)
        - traefik.http.routers.discourse-${NUMBER:-1}.entrypoints=${SCHEME:-https}
        - traefik.http.routers.discourse-${NUMBER:-1}.service=discourse-${NUMBER:-1}
        - traefik.http.routers.discourse-${NUMBER:-1}.tls.certresolver=letsencrypt
        - traefik.http.services.discourse-${NUMBER:-1}.loadbalancer.server.port=80
    networks:
      - traefik
      - internal

  postgres:
    image: ${POSTGRES_IMAGE:-discourse/postgres}:${POSTGRES_VERSION:-pg16}
    environment:
      - DB_USER=discourse
      - DB_PASSWORD=myp@ssw0rd
      - POSTGRES_DB=discourse
      - POSTGRES_USER=discourse
      - POSTGRES_PASSWORD=myp@ssw0rd
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "discourse"]
    volumes:
      - ${VOLUME_PATH}postgres:/var/lib/postgresql
    networks:
      - internal

  redis:
    image: redis:7-alpine
    environment:
      - ALLOW_EMPTY_PASSWORD=yes
    networks:
      - internal

volumes:
  data:
  postgres:

networks:
  internal:
    driver: overlay
    attachable: true
  traefik:
    external: true
    name: traefik-net
